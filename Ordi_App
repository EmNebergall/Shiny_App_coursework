#

# Biggest change to make: must add code for EDA to determine which parts of selected or loaded data should be retained for ordination
# add code to handle environmental variables

library(shiny)
library(vegan)
library(ape)

if(!exists("dune")) {
    data(dune)
    data(dune.env)
}

datas <- c("dune")

ords <- c("PCoA", "NMDS")

dists <- c("Euclidean", 
           "Bray Curtis",
           "Jaccard")

# Define UI for application that draws a histogram
ui <- fluidPage(

    # Application title
    titlePanel("Ordination Example"),
    
    fluidRow(column(4, selectInput("the_data", "Select Data", choices = datas)),
             column(4, selectInput("ords", "Select Ordination Method", choices = ords)),
             column(4, selectInput("dists", "Select Distance/Dissimilarity Measure", choices = dists))),

    # Sidebar with a slider input for number of bins 
    sidebarLayout(
        sidebarPanel(
            checkboxGroupInput(inputId = "env_vars",
                        label = "Environmental Variables: Select 2 to Display on Plot",
                        choices = names(dune.env),
                        selected = names(dune.env[c(2,3)]),
                        inline = FALSE)
        ),

        # Show a plot of the generated distribution
        mainPanel(
           plotOutput("ord_plot")
        ))
    )


ordinate <- function(ord_method, dist_mat) {
    if (ord_method == "PCoA") {
        ordination_output <- ape::pcoa(selected_data)
    } else {
        if (ord_method == "NMDS") {
            ordination_output <- metaMDS(
                selected_data,
                distance = NULL,
                autotransform = FALSE,
                k = 2
            )
            
        }
    }
    
    return(ordination_output)
}

measure_distance <- function(dis_method, selected_data) {
    if (dis_method == "Euclidean") {
        scale(selected_data)
    } else {
        if (dis_method == "Bray Curtis") {
            vegdist(selected_data)
        } else {
            if (dis_method == "Jaccard") {
                vegdist(selected_data, method = "jaccard")
            }
        }
    }
}

# Define server logic required to draw a histogram
server <- function(input, output) {
    
    selected_data <- reactive({
        #this has to change to accomodate more datasets
        get(input$the_data, "package:vegan")
    })
    
    selected_dis_measure <- reactive({
        input$dists
    })
    
    selected_ord_method <- reactive({
        input$ords
    })
    
    ready_data <- measure_distance(selected_dis_measure(), selected_data())
    
    
    the_ord <- ordination(selected_ord_method(), ready_data())


    output$ord_plot <- renderPlot({
        # generate bins based on input$bins from ui.R
        # These need to become reactives
        plot_df <- data.frame(
            axis_1 <- the_ord$vectors[, 1],
            axis_2 <- the_ord$vectors[, 2],
            env_color <- dune.env$Moisture,
            env_shape <- dune.env$Management
        )

        # draw the ordination
        ggplot2(data == plot_df,
                mapping = aes(x = axis_1, y = axis_2, color = env_color, shape = env_shape)) +
            geom_point(size = 4) +
            xlab("Axis 1") +
            ylab("Axis 2")
    })
}

# Run the application 
shinyApp(ui = ui, server = server)
